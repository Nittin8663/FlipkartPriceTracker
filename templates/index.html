<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flipkart Price Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-tags me-2"></i>Flipkart Price Tracker
            </span>
            <span class="navbar-text">
                <i class="fas fa-user me-2"></i>{{ user_login }}
                <i class="fas fa-clock ms-3 me-2"></i>{{ current_time }} UTC
            </span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <!-- Input Form -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-search me-2"></i>Track New Product
                        </h5>
                        <form id="trackingForm">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-link me-2"></i>Flipkart Product URL
                                </label>
                                <input type="url" class="form-control" id="productUrl" required
                                       placeholder="https://www.flipkart.com/product/...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-rupee-sign me-2"></i>Desired Price Threshold
                                </label>
                                <input type="number" class="form-control" id="thresholdPrice" required
                                       placeholder="Enter price in INR">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fab fa-telegram me-2"></i>Telegram Bot Token
                                </label>
                                <input type="text" class="form-control" id="telegramToken" required
                                       placeholder="Enter your bot token">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-comment me-2"></i>Telegram Chat ID
                                </label>
                                <input type="text" class="form-control" id="telegramChatId" required
                                       placeholder="Enter your chat ID">
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="startBtn">
                                    <i class="fas fa-play me-2"></i>Start Tracking
                                </button>
                                <button type="button" class="btn btn-danger" id="stopBtn" style="display: none;">
                                    <i class="fas fa-stop me-2"></i>Stop Tracking
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Status and History -->
            <div class="col-lg-6">
                <!-- Current Status -->
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-chart-line me-2"></i>Current Status
                        </h5>
                        <div id="statusContent">
                            <div class="mb-3">
                                <i class="fas fa-circle me-2"></i>
                                <span id="trackingStatus" class="tracking-inactive">Not tracking</span>
                            </div>
                            <div class="mb-3">
                                <i class="fas fa-shopping-cart me-2"></i>
                                <span id="productTitle">-</span>
                            </div>
                            <div class="mb-3">
                                <i class="fas fa-rupee-sign me-2"></i>
                                Current Price: <span id="currentPrice">-</span>
                            </div>
                            <div class="mb-3">
                                <i class="fas fa-clock me-2"></i>
                                Last Check: <span id="lastCheck" class="timestamp">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price History -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-history me-2"></i>Price History
                        </h5>
                        <div class="price-history">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Price (₹)</th>
                                            <th>Change</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('trackingForm');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            let previousPrice = null;
            
            // Update status
            function updateStatus() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        const statusElement = document.getElementById('trackingStatus');
                        const titleElement = document.getElementById('productTitle');
                        const priceElement = document.getElementById('currentPrice');
                        const lastCheckElement = document.getElementById('lastCheck');
                        
                        statusElement.textContent = data.is_tracking ? 'Tracking Active' : 'Not Tracking';
                        statusElement.className = data.is_tracking ? 'tracking-active' : 'tracking-inactive';
                        
                        if (data.current_data) {
                            titleElement.textContent = data.current_data.title;
                            priceElement.textContent = `₹${data.current_data.price}`;
                            lastCheckElement.textContent = data.current_data.timestamp;
                        }
                        
                        startBtn.style.display = data.is_tracking ? 'none' : 'block';
                        stopBtn.style.display = data.is_tracking ? 'block' : 'none';
                    });
            }

            // Update price history
            function updatePriceHistory() {
                fetch('/api/price_history')
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById('historyTableBody');
                        tableBody.innerHTML = '';
                        
                        data.forEach((entry, index) => {
                            const row = document.createElement('tr');
                            const priceChange = index < data.length - 1 
                                ? entry.price - data[index + 1].price 
                                : 0;
                            
                            const changeClass = priceChange > 0 
                                ? 'price-change-up' 
                                : priceChange < 0 
                                    ? 'price-change-down' 
                                    : '';
                            
                            const changeIcon = priceChange > 0 
                                ? '↑' 
                                : priceChange < 0 
                                    ? '↓' 
                                    : '-';
                            
                            row.innerHTML = `
                                <td class="timestamp">${entry.timestamp}</td>
                                <td>₹${entry.price}</td>
                                <td class="${changeClass}">
                                    ${changeIcon} ${Math.abs(priceChange).toFixed(2)}
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    });
            }

            // Start tracking
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const data = {
                    url: document.getElementById('productUrl').value,
                    threshold_price: document.getElementById('thresholdPrice').value,
                    telegram_token: document.getElementById('telegramToken').value,
                    telegram_chat_id: document.getElementById('telegramChatId').value
                };
                
                fetch('/api/start_tracking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if(result.status === 'success') {
                        updateStatus();
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                });
            });

            // Stop tracking
            stopBtn.addEventListener('click', function() {
                fetch('/api/stop_tracking')
                    .then(response => response.json())
                    .then(result => {
                        if(result.status === 'success') {
                            updateStatus();
                        }
                    });
            });

            // Update status and history every 30 seconds
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    updateStatus();
                    updatePriceHistory();
                }
            }, 30000);

            // Initial update
            updateStatus();
            updatePriceHistory();
        });
    </script>
</body>
</html>
