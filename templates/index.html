<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flipkart Price Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-tags me-2"></i>Flipkart Price Tracker
            </span>
            <span class="navbar-text">
                <i class="fas fa-user me-2"></i>{{ user_login }}
                <i class="fas fa-clock ms-3 me-2"></i>{{ current_time }} UTC
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Input Form -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Track New Product</h5>
                        <form id="trackingForm">
                            <div class="mb-3">
                                <label class="form-label">Flipkart Product URL</label>
                                <input type="url" class="form-control" id="productUrl" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Desired Price Threshold (₹)</label>
                                <input type="number" class="form-control" id="thresholdPrice" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telegram Bot Token</label>
                                <input type="text" class="form-control" id="telegramToken" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telegram Chat ID</label>
                                <input type="text" class="form-control" id="telegramChatId" required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="startBtn">
                                <i class="fas fa-play me-2"></i>Start Tracking
                            </button>
                            <button type="button" class="btn btn-danger" id="stopBtn" style="display: none;">
                                <i class="fas fa-stop me-2"></i>Stop Tracking
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Status and History -->
            <div class="col-md-6">
                <!-- Current Status -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Current Status</h5>
                        <div id="statusContent">
                            <p class="mb-2">
                                <i class="fas fa-circle text-secondary me-2"></i>
                                <span id="trackingStatus">Not tracking</span>
                            </p>
                            <p class="mb-2">
                                <i class="fas fa-rupee-sign me-2"></i>
                                Current Price: <span id="currentPrice">-</span>
                            </p>
                            <p class="mb-0">
                                <i class="fas fa-clock me-2"></i>
                                Last Check: <span id="lastCheck">-</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Price History -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Price History</h5>
                        <div class="price-history">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Price (₹)</th>
                                            <th>Change</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('trackingForm');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            function updateStatus() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        const statusElement = document.getElementById('trackingStatus');
                        const priceElement = document.getElementById('currentPrice');
                        const lastCheckElement = document.getElementById('lastCheck');
                        
                        statusElement.textContent = data.is_tracking ? 'Tracking Active' : 'Not tracking';
                        if (data.current_data) {
                            priceElement.textContent = `₹${data.current_data.price}`;
                            lastCheckElement.textContent = data.current_data.timestamp;
                        }
                        
                        startBtn.style.display = data.is_tracking ? 'none' : 'block';
                        stopBtn.style.display = data.is_tracking ? 'block' : 'none';
                    });
            }

            function updatePriceHistory() {
                fetch('/api/price_history')
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById('historyTableBody');
                        tableBody.innerHTML = '';
                        data.forEach(entry => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${entry.timestamp}</td>
                                <td>₹${entry.price}</td>
                                <td>${entry.price_change || '-'}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    });
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const data = {
                    url: document.getElementById('productUrl').value,
                    threshold_price: document.getElementById('thresholdPrice').value,
                    telegram_token: document.getElementById('telegramToken').value,
                    telegram_chat_id: document.getElementById('telegramChatId').value
                };
                
                fetch('/api/start_tracking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if(result.status === 'success') {
                        updateStatus();
                    }
                });
            });

            stopBtn.addEventListener('click', function() {
                fetch('/api/stop_tracking')
                    .then(response => response.json())
                    .then(result => {
                        if(result.status === 'success') {
                            updateStatus();
                        }
                    });
            });

            setInterval(() => {
                updateStatus();
                updatePriceHistory();
            }, 30000);

            updateStatus();
            updatePriceHistory();
        });
    </script>
</body>
</html>
